;(function ($) {
	
	var pluginName = 'loadingQueue';
	
	var LoadingQueue = function() {
		
		var self = this;
		
		this.queue = new Array();
		
		this.loading = false;
		
		this.step = 1;
		
		this.index = 0;
		
		this.buildUrl = function(image, options) {
			
			var url = null;
			
			if(options && options.length > 0) {
				
				$.each(options, function(prefix, size) {
					
					if(!url || screen.width > size.width && screen.height > size.height) {
						url = image.data('basePath') + prefix + image.data('fileName');
					}
				});
				
			} else if(image.data('src')) {
				
				url = image.data('src');
			
			} else {
				
				url = image.data('basePath') + image.data('fileName');
			}
			
			return url;
		};
		
		this.dequeue = function () {
			for (var i = self.step; i > 0; i --) {
				if (this.queue.length == 0)
					return;
				
				
				var item = this.queue.shift();
				if(item) {
					this.loading = true;
					if(!item.image.is('img')) {
						self.index += 1;
						if (self.index == self.step) {
							self.index = 0;
							self.dequeue();
						}
						return;
					}
					
					var src = this.buildUrl(item.image, item.options);
					item.image.on('load', function() {						
						item.image.trigger('loaded');
						self.index += 1;
						if (self.index == self.step) {
							self.index = 0;
							self.dequeue();
						}
						
					})
					.on('error', function() {
						self.index += 1;
						if (self.index == self.step) {
							self.index = 0;
							self.dequeue();
						}
					})
					.attr('src', src);

				} else {
					this.loading = false;
				}
			}
		};
			
		this.enqueue = function(image, options) {
			this.queue.push({
				image: $(image),
				options: options
			});			
		};
	};	
		
	$.fn[pluginName] = function (options, step) {
		var q = new LoadingQueue();
		var step = (step == undefined) ? 1 : parseInt(step);
		q.step = step < 1 ? 1 : step;
		q.counter = q.step;

		$(this).each(function() {
			q.enqueue($(this), options);
		});	

		if(!q.loading) {
			q.dequeue();
		}		
		
		return this;
	};
	
})(jQuery);
